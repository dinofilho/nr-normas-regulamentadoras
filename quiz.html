<!DOCTYPE html><html lang="pt-BR"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Avaliação Teórica</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif;background:#f8fafc;margin:0}
  .wrap{max-width:920px;margin:32px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:20px}
  h1{margin:0 0 16px;font-size:28px}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
  .row input{flex:1 1 260px;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
  .q{border-top:1px dashed #e5e7eb;padding-top:14px;margin-top:14px}
  .q h3{font-size:16px;margin:0 0 8px}
  .opts label{display:block;margin:6px 0;cursor:pointer}
  .btn{background:#2563eb;color:#fff;border:0;border-radius:12px;padding:12px 18px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:12px 0;color:#b91c1c}
  .ok{color:#065f46}
</style>
</head><body>
<div class="wrap"><div class="card">
  <h1>Avaliação Teórica</h1>
  <div id="cursoInfo" class="row"></div>
  <div class="row">
    <input id="nome" placeholder="Nome completo">
    <input id="cpf" placeholder="CPF (000.000.000-00)">
    <input id="email" placeholder="(opcional) e-mail">
  </div>
  <div id="quiz"></div>
  <div class="row" style="margin-top:18px"><button id="enviar" class="btn">Enviar respostas</button></div>
  <div id="msg" class="msg"></div>
</div></div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const msg = (t,ok=false)=>{ const m=$("#msg"); m.textContent=t; m.className = ok?"msg ok":"msg"; };
  const params = new URLSearchParams(location.search);
  const raw = (params.get("curso")||"nr1").toLowerCase();
  const curso = raw.replace(/[^a-z0-9]/g,""); // "nr-33" -> "nr33"
  const human = "NR-" + curso.replace("nr","");

  $("#cursoInfo").innerHTML = '<input value="'+human+'" disabled>';

  function normalizeQuestionsContainer(data){
    if(Array.isArray(data)) return data;
    const pickKeys=(obj, keys)=>keys.map(k=>obj?.[k]).find(v=>Array.isArray(v)&&v.length);
    let arr = pickKeys(data||{}, [curso, curso.toUpperCase(), "nr-"+curso.slice(2), ("NR-"+curso.slice(2))]);
    if(arr) return arr;
    const q = data && (data.questions || data.qs || data.items);
    if(q && typeof q==="object"){
      arr = pickKeys(q, [curso, curso.toUpperCase(), "nr-"+curso.slice(2), ("NR-"+curso.slice(2))]);
      if(arr) return arr;
      // tenta por nome normalizado
      for(const k of Object.keys(q)){
        if(Array.isArray(q[k]) && k.toLowerCase().replace(/[^a-z0-9]/g,"")===curso) return q[k];
      }
    }
    // último recurso: percorre chaves de primeiro nível
    if(data && typeof data==="object"){
      for(const k of Object.keys(data)){
        if(Array.isArray(data[k]) && k.toLowerCase().replace(/[^a-z0-9]/g,"")===curso) return data[k];
      }
    }
    return [];
  }

  // --- CANONIZA UMA QUESTÃO --- //
  function canon(it){
    const clean = (v)=> (v==null ? "" : String(v)).trim();
    const isBad = (v)=> !v || /^\s*$/.test(v) || /^\s*1\s*$/.test(v); // "1" de placeholder
    const q = clean(it.q || it.question || it.pergunta || "");
    let a = clean(it.a), b = clean(it.b), c = clean(it.c), d = clean(it.d);

    // Se veio options: [...]
    if((!a && !b && !c && !d) && Array.isArray(it.options)){
      [a,b,c,d] = (it.options.map(clean).concat(["","", "", ""])).slice(0,4);
    }

    // Se só A tem tudo colado por vírgula e B/C/D vazias/“1”, divide A
    if(!isBad(a) && (isBad(b)&&isBad(c)&&isBad(d)) && a.includes(",")){
      const parts = a.split(",").map(s=>s.trim()).filter(Boolean);
      [a,b,c,d] = (parts.concat(["","", "", ""])).slice(0,4);
    }

    // Garante 4 alternativas
    a = a || "—"; b = b || "—"; c = c || "—"; d = d || "—";

    // Normaliza resposta
    let ans = it.ans ?? it.answer ?? it.correct ?? it.resp ?? it.certa;
    if(typeof ans === "number"){ ans = ['a','b','c','d'][Math.max(0, Math.min(3, ans>0?ans-1:ans))]; }
    if(typeof ans === "string"){
      let s = ans.trim().toLowerCase();
      if(/^[abcd]$/.test(s)) { /* ok */ }
      else if(/^[1234]$/.test(s)) { ans = ['a','b','c','d'][parseInt(s,10)-1]; }
      else if(/^[0-3]$/.test(s)) { ans = ['a','b','c','d'][parseInt(s,10)]; }
      else {
        // tenta casar pelo texto da alternativa
        const map = {a,b,c,d};
        for(const k of ['a','b','c','d']){
          if(map[k].toLowerCase()===s) { ans = k; break; }
        }
      }
    }
    if(!/^[abcd]$/.test(String(ans))) ans = 'a'; // fallback seguro

    return { q, a, b, c, d, ans };
  }

  async function loadQuestions(){
    const urls = [
      `assets/questions/${curso}.json`,
      `assets/questions/nr-${curso.slice(2)}.json`,
      'assets/questions/questions.json'
    ];
    for(const u of urls){
      try{
        const r = await fetch(u, {cache:'no-store'});
        if(!r.ok) continue;
        const j = await r.json();
        const arr = normalizeQuestionsContainer(j);
        if(arr && arr.length) return arr.map(canon);
      }catch(e){}
    }
    return [];
  }

  function render(questions){
    const host = $("#quiz");
    host.innerHTML = "";
    questions.forEach((it,idx)=>{
      const qid = `q${idx+1}`;
      const block = document.createElement("div");
      block.className = "q";
      block.innerHTML = `
        <h3>${idx+1}. ${it.q}</h3>
        <div class="opts">
          ${['a','b','c','d'].map(k=>{
            const label = it[k] ?? '';
            return `<label><input type="radio" name="${qid}" value="${k}"> ${label}</label>`;
          }).join('')}
        </div>`;
      host.appendChild(block);
    });
  }

  function nota(questions){
    let ok=0;
    questions.forEach((it,idx)=>{
      const sel = document.querySelector(`input[name="q${idx+1}"]:checked`);
      if(sel && sel.value === it.ans) ok++;
    });
    return Math.round((ok/questions.length)*100);
  }

  function comprovante(curso,nome,cpf,email,score){
    const url = new URL('comprovante.html', location.href);
    url.searchParams.set('curso', curso.toUpperCase());
    url.searchParams.set('nome', nome);
    url.searchParams.set('cpf', cpf);
    url.searchParams.set('nota', String(score));
    if(email) url.searchParams.set('email', email);
    location.href = url.toString();
  }

  loadQuestions().then(qts=>{
    if(!qts.length){
      msg('Não foi possível carregar as questões deste curso (nenhuma questão encontrada).');
      $("#enviar").disabled = true;
      return;
    }
    render(qts); msg('Carregado. Responda e envie.', true);
    $("#enviar").onclick = ()=>{
      const nome=$("#nome").value.trim(), cpf=$("#cpf").value.trim(), email=$("#email").value.trim();
      if(!nome || !cpf){ msg('Preencha Nome e CPF para continuar.'); return; }
      const score = nota(qts);
      comprovante(curso, nome, cpf, email, score);
    };
  });
})();
</script>
<script src="/nr-normas-regulamentadoras/inject-date.js" defer></script>
</body></html>
